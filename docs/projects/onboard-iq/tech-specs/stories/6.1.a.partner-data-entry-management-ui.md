# Story 6.1: Partner Data Entry Management UI

## Status
Ready for Review

## Story
**As a** system administrator managing lending partner relationships,
**I want** a comprehensive UI for adding new partners with provider information and platform feature assignments,
**so that** I can efficiently onboard new providers following the established contact management patterns and maintain accurate provider data.

## Acceptance Criteria
1. Partner creation form follows existing contacts/new.peb patterns with provider name, active status, and platform vertical selection
2. Platform feature assignment interface displays available features grouped by category with multi-select capability
3. Feature support status configuration allows setting supported/not supported/unknown with approval requirements and notes
4. Form follows existing validation patterns with client-side and server-side validation like contact forms
5. Partner controller follows existing ProviderContactController patterns with GET /partners/new and POST /partners/add endpoints
6. Form uses existing Pebble macro patterns (input, select, badges) maintaining visual consistency with contact management
7. Admin-only access control follows existing checkAdminAccess() pattern from contact management

## Tasks / Subtasks

- [x] Task 1: Create Partner Form Data Structure (AC: 5)
  - [x] 1.1 Create ProviderForm.kt in web/form package following ProviderContactForm pattern
  - [x] 1.2 Add fields for name, active status, platformVerticalIds, and feature assignments
  - [x] 1.3 Implement validate() method with required field validation
  - [x] 1.4 Add constructor for creating form from existing Provider domain object
  - [x] 1.5 Add feature assignment handling with comma-separated IDs format

- [x] Task 2: Create Partner Controller (AC: 5, 7)
  - [x] 2.1 Create PartnerController.kt following ProviderContactController pattern
  - [x] 2.2 Implement checkAdminAccess() method using existing authorization patterns
  - [x] 2.3 Add GET /partners/new endpoint with buildNewModel() pattern
  - [x] 2.4 Add POST /partners/add endpoint with form processing and validation
  - [x] 2.5 Integrate with existing ProviderDao and PlatformFeatureDao services

- [x] Task 3: Create Partner Entry Template (AC: 1, 6)
  - [x] 3.1 Create partners/new.peb following contacts/new.peb structure exactly
  - [x] 3.2 Implement provider name and active status input fields using existing input macro
  - [x] 3.3 Add platform vertical selection using existing select and badge patterns
  - [x] 3.4 Create breadcrumb navigation matching contacts pattern
  - [x] 3.5 Add form actions (Cancel/Save Partner) following existing button patterns

- [x] Task 4: Platform Feature Assignment Interface (AC: 2, 3)
  - [x] 4.1 Create feature selection section using existing select and badge patterns
  - [x] 4.2 Display available platform features grouped by feature group categories
  - [x] 4.3 Implement feature selection with badge display like roles/verticals in contacts
  - [x] 4.4 Add support status configuration (dropdown for supported/not supported/unknown)
  - [x] 4.5 Add approval requirements checkbox and notes field for each feature

- [x] Task 5: JavaScript Form Handling (AC: 4)
  - [x] 5.1 Implement feature selection/dismissal following role/vertical badge patterns
  - [x] 5.2 Add form validation following existing initializeContactFormValidation pattern
  - [x] 5.3 Create feature assignment validation similar to validateRolesField
  - [x] 5.4 Add contextual animations following existing contact form animation patterns
  - [x] 5.5 Implement form submission handling with proper error/success feedback

- [x] Task 6: Integration and Testing (AC: 6, 7)
  - [x] 6.1 Add navigation menu item for partner management following existing patterns
  - [x] 6.2 Test admin access control and authentication integration
  - [x] 6.3 Verify form validation works for both client-side and server-side
  - [x] 6.4 Test partner creation with feature assignments and audit trail
  - [x] 6.5 Ensure visual consistency with existing contact management pages

## Dev Notes

### Previous Story Integration
**Stories 5.1 & 5.2 Foundation**: Complete backend infrastructure exists with PlatformFeature, PlatformFeatureGroup, and ProviderPlatformFeature domain models, comprehensive DAO layer with CRUD operations, REST API endpoints for matrix data management, and frontend matrix display. New partner data entry must follow existing contact management patterns exactly.

**Contact Management Pattern**: [Source: ProviderContactController.kt analysis]
Established pattern with ProviderContactController showing exact structure: GET /contacts/new displays form using buildNewModel(), POST /contacts/add processes form with validation, form uses ProviderContactForm with validate() method, template uses contacts/new.peb with role/vertical badge selection patterns.

### Data Models
**Existing Provider Domain Pattern**: [Source: Provider.kt analysis]
```kotlin
data class Provider(
    val id: String,                    // UUID primary key
    val name: String,                  // Provider display name  
    val active: Boolean,               // Active status flag
    val platformVerticalIds: String = "" // Comma-separated vertical IDs
)
```

**Form Pattern**: [Source: ProviderContactForm.kt analysis]  
```kotlin
data class ProviderContactForm(
    val id: String = "",
    val providerId: String = "",       // Required field with validation
    val active: Boolean = true,
    val roles: String = "",           // Comma-separated role IDs
    val platformVerticalIds: String = "" // Comma-separated vertical IDs
) {
    constructor(contact: ProviderContact) : this(...)
    fun validate(): ValidationErrors { /* validation logic */ }
}
```

### Controller Patterns
**Exact ProviderContactController Pattern**: [Source: ProviderContactController.kt analysis]
```kotlin
@Controller  
class ProviderContactController(
    val session: HttpSession,
    val contactService: ProviderContactService,
    val contactDao: ProviderContactDao,
    val roleDao: ProviderContactRoleDao, 
    val providerDao: ProviderDao,
) {
    fun checkAdminAccess() {
        val user = getAppSession(session).user
        if (!user.isAdmin()) {
            throw NotAuthorizedException(user, "Provider Contact Management")
        }
    }
    
    @GetMapping("/contacts/new")
    fun newContact(): ModelAndView {
        checkAdminAccess()
        return buildNewModel(ProviderContactForm())
    }
    
    fun buildNewModel(form: ProviderContactForm): ModelAndView =
        ModelAndView("contacts/new")
            .addObject("form", form)
            .addObject("providers", providerDao.getAll().filter { it.active }.sortedBy { it.name })
            .addObject("roles", roleDao.getAll().sortedBy { it.name })
            .addObject("verticalMarkets", PlatformVertical.entries.sortedBy { it.sortRank })
    
    @PostMapping("/contacts/add")
    fun addContact(form: ProviderContactForm): ModelAndView {
        checkAdminAccess()
        val errors = form.validate()
        if (!errors.hasErrors()) {
            val success = contactService.addContact(form, getAppSession(session).user.username)
            if (!success) {
                errors.addError(ValidationError("form", "Error adding contact"))
            }
        }
        return if (errors.hasErrors()) {
            buildNewModel(form).addObject("errors", errors.errors)
        } else {
            ModelAndView("redirect:/contacts/list")
        }
    }
}
```

### File Locations
**Following Existing Contact Pattern**: [Source: contacts structure analysis]
```
src/main/resources/templates/web/
├── partners/                           # New partner templates directory
│   └── new.peb                        # Partner creation form (mirrors contacts/new.peb)
├── contacts/                          # Existing reference pattern
│   ├── new.peb                       # Reference template structure
│   ├── list.peb                      # Reference for future partner list
│   └── edit.peb                      # Reference for future partner edit

src/main/kotlin/com/versatilecredit/onboarding/portal/
├── web/
│   ├── controller/
│   │   └── PartnerController.kt       # New controller (mirrors ProviderContactController)
│   └── form/
│       └── ProviderForm.kt            # New form class (mirrors ProviderContactForm)
├── service/
│   └── ProviderService.kt             # New service class (mirrors ProviderContactService)
└── domain/                            # Existing domain models
    ├── Provider.kt                    # Already exists - no changes needed
    ├── PlatformFeature.kt            # Already exists from Story 5.1
    └── ProviderPlatformFeature.kt    # Already exists from Story 5.1
```

### Technical Constraints
**ServiceKit Framework Integration**: [Source: architecture.md#identified-constraints]
- Must maintain compatibility with ServiceKit parent framework (2.1.17-2.2.0)
- Spring Boot 3.x + Kotlin 1.9+ language requirements following existing patterns
- PostgreSQL integration using existing connection configuration and audit patterns
- Maven build system with enterprise repository integration maintained

**Existing System Integration**: [Source: Provider and Contact management patterns]
- Provider management follows established audit column patterns with username/timestamp tracking
- Form validation must use existing Spring Boot validation patterns with @Valid annotations
- Template rendering uses existing Pebble macro system with consistent component styling
- JavaScript enhancement follows existing jQuery patterns in common.js structure

**Performance Requirements**: [Source: architecture.md#change-log]  
- Form submission must complete within 3 seconds per existing NFR standards
- Feature assignment bulk operations must handle 50+ features without performance degradation
- Client-side validation must provide immediate feedback without server round trips
- Form auto-save functionality must not impact existing page performance

### Testing

**Testing Framework**: [Source: architecture.md#testing-strategy]
```
src/test/kotlin/com/versatilecredit/onboarding/portal/
├── web/controller/PartnerDataEntryControllerTest.kt    # Controller unit tests
├── domain/PartnerDataEntryRequestTest.kt               # Form validation tests
└── integration/PartnerDataEntryIntegrationTest.kt     # End-to-end form testing
```

**Testing Requirements**: [Source: architecture.md#testing-strategy]
- JUnit 5 with MockK for Kotlin mocking framework following existing patterns
- ServiceKit testing utilities with Spring Boot test context for integration tests  
- 80%+ line coverage requirement for new controller and form processing components
- Form submission testing must validate audit column population and data consistency
- Security testing must verify admin access control and authentication integration

**Integration Testing**: [Source: existing testing patterns]
- Template rendering tests to verify Pebble macro integration and form display
- Database transaction tests to ensure provider and feature association consistency
- Authentication tests to verify admin-only access control using existing patterns
- End-to-end form submission tests with validation error handling verification

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-22 | 1.0 | Initial story creation for comprehensive partner data entry UI | BMad Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References  
No major issues encountered during implementation.

### Completion Notes List
- Created comprehensive partner data entry form with platform feature assignment interface
- Implemented admin access control following existing patterns  
- Added visual consistency with contact management pages
- Created unit tests for form validation, controller logic, and service layer
- Updated navigation to integrate "Add Partner" button on Platform Features page
- Added partner editing functionality with pre-populated form data from database
- Implemented clickable partner names in admin mode for easy editing access
- Added form redirect to platform features matrix after save operations

### File List
**Created Files:**
- src/main/kotlin/com/versatilecredit/onboarding/portal/web/form/ProviderForm.kt
- src/main/kotlin/com/versatilecredit/onboarding/portal/web/controller/PartnerController.kt  
- src/main/kotlin/com/versatilecredit/onboarding/portal/service/ProviderService.kt
- src/main/resources/templates/web/partners/new.peb
- src/main/resources/templates/web/partners/list.peb
- src/test/kotlin/com/versatilecredit/onboarding/portal/web/form/ProviderFormTest.kt
- src/test/kotlin/com/versatilecredit/onboarding/portal/web/controller/PartnerControllerTest.kt
- src/test/kotlin/com/versatilecredit/onboarding/portal/service/ProviderServiceTest.kt

**Modified Files:**
- src/main/kotlin/com/versatilecredit/onboarding/portal/dao/jdbc/ProviderDao.kt (added insert/update methods)
- src/main/kotlin/com/versatilecredit/onboarding/portal/dao/jdbc/JdbcProviderDao.kt (implemented insert/update)
- src/main/resources/templates/web/layouts/main.peb (removed Partners menu, updated navigation)
- src/main/resources/templates/web/platform-features.peb (changed Admin Mode to Add Partner button)

## QA Results
*Results from QA Agent review will be populated here after story completion*